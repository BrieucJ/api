# -------------------------
# 1️⃣ Build stage
FROM oven/bun:debian AS build
WORKDIR /var/task

# Copy root & workspace package files
COPY package.json bun.lock ./
COPY apps/backend/package.json apps/backend/package.json
COPY apps/client/package.json apps/client/package.json
COPY apps/worker/package.json apps/worker/package.json
COPY apps/backend/tsconfig.json ./apps/backend/tsconfig.json
COPY packages packages

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source code
COPY apps/backend/src ./apps/backend/src

# Build Lambda: output to directory (bun outputs lambda.js directly in outdir when bundling)
# Mark geoip-lite as external since it needs its data files at runtime
RUN mkdir -p /var/task/dist
RUN bun build apps/backend/src/servers/lambda.ts \
    --target=node \
    --format=esm \
    --bundle \
    --minify \
    --sourcemap \
    --external geoip-lite \
    --tsconfig apps/backend/tsconfig.json \
    --outdir /var/task/dist


# -------------------------
# 2️⃣ Runtime stage
FROM public.ecr.aws/lambda/nodejs:20
WORKDIR /var/task

# Copy package.json and the bundled Lambda
COPY apps/backend/package.json ./package.json
COPY --from=build /var/task/dist/src/servers/lambda.js ./lambda.js

# Install geoip-lite (marked as external, needs to be available at runtime)
# This will install the package with all its data files
RUN npm install --production --omit=dev geoip-lite

# Lambda handler
CMD ["lambda.handler"]
