name: Deploy Code to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_ENV: production
  AWS_REGION: eu-west-3

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Pulumi
        run: |
          mkdir -p ~/.pulumi/stacks
          bun x pulumi login file://~/.pulumi/stacks

      - name: Get Infrastructure Outputs
        id: infra
        working-directory: infra
        env:
          PULUMI_NODEJS_USE_TS_NODE: "true"
          PULUMI_CONFIG_PASSPHRASE: ""
        run: |
          export TS_NODE_PROJECT="$(pwd)/tsconfig.json"

          # Worker outputs
          WORKER_REPO=$(bun x pulumi stack output ecrRepoUrl -s worker-prod)
          WORKER_LAMBDA=$(bun x pulumi stack output workerLambdaName -s worker-prod)
          WORKER_QUEUE=$(bun x pulumi stack output queueUrl -s worker-prod)

          # Backend outputs
          BACKEND_REPO=$(bun x pulumi stack output ecrRepoUrl -s lambda-prod)
          BACKEND_LAMBDA=$(bun x pulumi stack output apiLambdaName -s lambda-prod)
          API_URL=$(bun x pulumi stack output apiUrl -s lambda-prod)

          # Client outputs
          CLIENT_BUCKET=$(bun x pulumi stack output bucketName -s client-prod)
          CLIENT_DIST=$(bun x pulumi stack output distributionId -s client-prod)

          echo "worker_repo=${WORKER_REPO}" >> $GITHUB_OUTPUT
          echo "worker_lambda=${WORKER_LAMBDA}" >> $GITHUB_OUTPUT
          echo "worker_queue=${WORKER_QUEUE}" >> $GITHUB_OUTPUT
          echo "backend_repo=${BACKEND_REPO}" >> $GITHUB_OUTPUT
          echo "backend_lambda=${BACKEND_LAMBDA}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "client_bucket=${CLIENT_BUCKET}" >> $GITHUB_OUTPUT
          echo "client_dist=${CLIENT_DIST}" >> $GITHUB_OUTPUT

      - name: Build Worker Docker Image
        run: |
          docker build -t worker-prod -f .docker/Dockerfile.worker .

      - name: Push Worker Image to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${{ steps.infra.outputs.worker_repo }}
          docker tag worker-prod ${{ steps.infra.outputs.worker_repo }}:prod
          docker push ${{ steps.infra.outputs.worker_repo }}:prod

      - name: Update Worker Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.infra.outputs.worker_lambda }} \
            --image-uri ${{ steps.infra.outputs.worker_repo }}:prod \
            --region ${{ env.AWS_REGION }} \
            --wait
          cat > /tmp/env.json <<EOF
          {"Variables":{"DATABASE_URL":"${{ secrets.DATABASE_URL }}","LOG_LEVEL":"${{ secrets.LOG_LEVEL }}","NODE_ENV":"production","WORKER_MODE":"lambda","SQS_QUEUE_URL":"${{ steps.infra.outputs.worker_queue }}"}}
          EOF
          aws lambda update-function-configuration \
            --function-name ${{ steps.infra.outputs.worker_lambda }} \
            --environment file:///tmp/env.json \
            --region ${{ env.AWS_REGION }} \
            --wait

      - name: Build Backend Docker Image
        run: |
          docker build -t api-prod -f .docker/Dockerfile.lambda .

      - name: Push Backend Image to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${{ steps.infra.outputs.backend_repo }}
          docker tag api-prod ${{ steps.infra.outputs.backend_repo }}:prod
          docker push ${{ steps.infra.outputs.backend_repo }}:prod

      - name: Update Backend Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.infra.outputs.backend_lambda }} \
            --image-uri ${{ steps.infra.outputs.backend_repo }}:prod \
            --region ${{ env.AWS_REGION }} \
            --wait
          cat > /tmp/env.json <<EOF
          {"Variables":{"DATABASE_URL":"${{ secrets.DATABASE_URL }}","LOG_LEVEL":"${{ secrets.LOG_LEVEL }}","NODE_ENV":"production","PORT":"${{ secrets.PORT }}","SQS_QUEUE_URL":"${{ steps.infra.outputs.worker_queue }}"}}
          EOF
          aws lambda update-function-configuration \
            --function-name ${{ steps.infra.outputs.backend_lambda }} \
            --environment file:///tmp/env.json \
            --region ${{ env.AWS_REGION }} \
            --wait

      - name: Build Client
        working-directory: apps/client
        env:
          VITE_BACKEND_URL: ${{ steps.infra.outputs.api_url }}
        run: |
          bun install --frozen-lockfile
          bun run build

      - name: Deploy Client to S3
        run: |
          aws s3 sync apps/client/dist/ s3://${{ steps.infra.outputs.client_bucket }}/ \
            --region ${{ env.AWS_REGION }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"
          aws s3 sync apps/client/dist/ s3://${{ steps.infra.outputs.client_bucket }}/ \
            --region ${{ env.AWS_REGION }} \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html"

      - name: Invalidate CloudFront Cache
        if: steps.infra.outputs.client_dist != '' && steps.infra.outputs.client_dist != 'None'
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.infra.outputs.client_dist }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text
