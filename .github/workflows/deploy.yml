name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_ENV: production
  AWS_REGION: eu-west-3

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: get-account-id
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Build and Deploy Backend Lambda
        run: |
          # Build Docker image
          docker build -t api-prod -f .docker/Dockerfile.lambda .

          # Login to ECR
          ECR_REPO_URL="${{ steps.get-account-id.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/api-prod"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${ECR_REPO_URL}

          # Tag and push
          docker tag api-prod ${ECR_REPO_URL}:prod
          docker push ${ECR_REPO_URL}:prod

          # Update Lambda function (function name: api-prod-apiLambda)
          aws lambda update-function-code \
            --function-name api-prod-apiLambda \
            --image-uri ${ECR_REPO_URL}:prod \
            --region ${{ env.AWS_REGION }} \
            --wait

          echo "‚úÖ Backend Lambda deployed successfully"

      - name: Get Backend API URL
        id: get-api-url
        run: |
          # Get API Gateway endpoint (API name: api-prod-apiGateway)
          API_ID=$(aws apigatewayv2 get-apis --region ${{ env.AWS_REGION }} --query "Items[?contains(Name, 'api-prod')].ApiId" --output text | head -1)
          if [ -n "$API_ID" ] && [ "$API_ID" != "None" ]; then
            API_URL=$(aws apigatewayv2 get-api --api-id ${API_ID} --region ${{ env.AWS_REGION }} --query 'ApiEndpoint' --output text)
            if [ -n "$API_URL" ] && [ "$API_URL" != "None" ]; then
              echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
              echo "Backend API URL: ${API_URL}"
            fi
          fi

      - name: Build and Deploy Worker Lambda
        run: |
          # Build Docker image
          docker build -t worker-prod -f .docker/Dockerfile.worker .

          # Login to ECR
          ECR_REPO_URL="${{ steps.get-account-id.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/worker-prod"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${ECR_REPO_URL}

          # Tag and push
          docker tag worker-prod ${ECR_REPO_URL}:prod
          docker push ${ECR_REPO_URL}:prod

          # Update Lambda function (function name: worker-prod-lambda)
          aws lambda update-function-code \
            --function-name worker-prod-lambda \
            --image-uri ${ECR_REPO_URL}:prod \
            --region ${{ env.AWS_REGION }} \
            --wait

          echo "‚úÖ Worker Lambda deployed successfully"

      - name: Build Client
        working-directory: apps/client
        env:
          VITE_BACKEND_URL: ${{ steps.get-api-url.outputs.api_url }}
        run: |
          bun install --frozen-lockfile
          bun run build

      - name: Deploy Client to S3 and CloudFront
        run: |
          # Get S3 bucket name (bucket name: client-prod-bucket)
          BUCKET_NAME=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'client-prod-bucket')].Name" --output text | head -1)
          if [ -z "$BUCKET_NAME" ]; then
            echo "‚ùå Could not find S3 bucket for client-prod. Is infrastructure deployed?"
            exit 1
          fi

          echo "üì§ Uploading to S3 bucket: ${BUCKET_NAME}"
          # Upload static assets with long cache
          aws s3 sync apps/client/dist/ s3://${BUCKET_NAME}/ \
            --region ${{ env.AWS_REGION }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # Upload HTML files with no cache
          aws s3 sync apps/client/dist/ s3://${BUCKET_NAME}/ \
            --region ${{ env.AWS_REGION }} \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html"

          # Get CloudFront distribution ID and invalidate cache
          DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Comment, 'client-prod')].Id" --output text | head -1)
          if [ -n "$DIST_ID" ] && [ "$DIST_ID" != "None" ]; then
            echo "üîÑ Invalidating CloudFront cache..."
            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id ${DIST_ID} \
              --paths "/*" \
              --query 'Invalidation.Id' \
              --output text)
            echo "‚úÖ CloudFront invalidation created: ${INVALIDATION_ID}"
          else
            echo "‚ö†Ô∏è  Could not find CloudFront distribution"
          fi

          echo "‚úÖ Client deployed successfully"
